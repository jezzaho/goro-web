<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rozkładacz</title>
</head>
<body>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap");
        
        body {
  
            background: rgb(63, 78, 127);
            background: linear-gradient(
            228deg,
            rgba(63, 78, 127, 1) 0%,
            rgba(119, 199, 197, 1) 100%
          );
          background-repeat: no-repeat;
          background-attachment: fixed;
        }
        
        .title-container {
          font-family: "Bebas Neue";
          font-size: 5vh;
          padding-bottom: 5vh;
        }
        .card-container {
          background: #fff;
          font-size: 1.6vh;
          font-family: "Nunito";
          margin: 0 auto;
          margin-top: 3.5em;
          width: 80vw;
          display: flex;
          flex-flow: column nowrap;
          align-items: center;
          box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }
        .card-container > div {
          align-self: center;
          text-align: center;
          
        }
        .introduction-container > div {
          height: 4rem;
          margin-bottom: 5vh;
        }
        #downloadForm {
          width: 100%;
          text-align: center;
        }
        .carrier-flex-container {
          display: grid;
          grid-template-rows: repeat(3, auto);
          grid-auto-flow: column;
          justify-content: space-evenly;
          margin-bottom: 1.5em;
          align-items: center;
        }
        .carrier-flex-container > .carrier-element {
          display: flex;
          flex-flow: row nowrap;
        }
        .carrier-flex-container > .carrier-element > input {
          margin-right: 1em;
        }
        
        .carrier-flex-container input[type="radio"] {
          opacity: 0;
          position: fixed;
          width: 0;
        }
        .carrier-flex-container label {
          display: inline-block;
          color: white;
          font-weight: 600;
          background-color: #3f4e7f;
          padding-top: 3%;
          padding-left: 0.2vw;
          padding-right: 0.2vw;
          font-family: sans-serif;
          font-size: 1.5vh;
          border: 1px solid #142ebd;
          border-radius: 4px;
          width: 30vw;
          height: 3vh;
          margin: 0.6vh;
          align-items: center;
          justify-content: center;
        }
        
        .carrier-flex-container input[type="radio"]:checked + label {
          background-color: #77c7c5;
          border-color: #77c7c5;
          color: black;
        }
        
        .date-flex-container {
          display: flex;
          flex-flow: row nowrap;
          justify-content: space-around;
          margin-bottom: 1.5em;
        }
        .date-flex-container label {
        
          padding-top: 3%;
        }
        .season-flex-container {
          margin-top: 1em;
          margin-bottom: 1.5em;
          display: flex;
          flex-flow: row nowrap;
          justify-content: space-evenly;
        }
        .separation-container {
          margin-bottom: 1.5em;
        }
        button {
          margin-bottom: 1.5em;
        }
        
        .form-label {
          font-family: "Bebas Neue";
          font-size: 3vh;
          margin-bottom: 1vh;
        }
        
        .date-flex-container input[type="date"] {
          background-color: #3f4e7f;
          color: white;
          font-weight: 800;
          padding: 8px 14px;
          font-size: 1.6vw;
          border: none;
          outline: none;
          border-radius: 5px;
          width: 15vw;
          margin: 0.6vh;
        }
        ::-webkit-calendar-picker-indicator {
          background-color: #fff;
          padding: 5px;
          cursor: pointer;
          border-radius: 3px;
        }
        
        .season-flex-container input[type="radio"] {
          opacity: 0;
          position: fixed;
          width: 0;
        }
        .season-flex-container label {
          display: inline-block;
          color: white;
          font-weight: 600;
          background-color: #3f4e7f;
          padding-top: 3%;
          padding-bottom: 3%;
          font-family: sans-serif;
          font-size: 1.6vh;
          border: 2px solid #444;
          border-radius: 4px;
          width: 20vw;
          margin: 0.6vh;
  
        }
        .season-flex-container input[type="radio"]:checked + label {
          background-color: #77c7c5;
          border-color: #77c7c5;
          color: black;
        }
        
        .separation-container input[type="checkbox"] {
          opacity: 0;
          position: fixed;
          width: 0;
        }
        .separation-container label {
          display: inline-block;
          color: white;
          font-weight: 600;
          background-color: #3f4e7f;
          padding-top: 1.25%;
          padding-bottom: 1.25%;
          font-family: sans-serif;
          font-size: 1.6vh;
          border: 2px solid #444;
          border-radius: 4px;
          width: 25vw;
          height: 2.5vh;
          margin: 0.6vh;
        
        }
        .separation-container input[type="checkbox"]:checked + label {
          background-color: #77c7c5;
          border-color: #77c7c5;
          color: black;
        }
        button {
          background-color: #3f4e7f;
          color: white;
          font-weight: 900;
          font-size: 16px;
          padding: 16px 32px;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        button:hover {
          animation: pulse 3s infinite;
        }
        @keyframes pulse {
          0% { background-color: #3f4e7f; color: #fff; }
          50% { background-color: #77c7c5; color: #000; }
          100% { background-color: #3f4e7f; color: #fff; }
        }
        .cc {
          font-size: 8px;
        }
        
        
    </style>
    <body>
        <!-- Loading overlay -->
        <div class="loader"></div>
        <div class="loader-container"> </div>
        <div class="card-container">
          <div class="introduction-container">
            <div class="title-container">
              <h1>Rozkładacz</h1>
            </div>
            <div class="paragraph-container">
              <p> Celem pobrania rozkładu wybranego przewoźnika w zadanym przedziale czasowym, wybierz odpowiednie pola ponizej. <br> Na ten moment rozkładacz pozwala na pobranie jednego rozkładu jednej linii w pojedynczym zapytaniu. <br> Czas pobrania rozkładu wynosi ok. 20-30 sekund i jest ograniczony przez limit API Lufthansy. </p>
            </div>
          </div>
          <form id="downloadForm" onsubmit="return handleDownload(event)" method="POST" enctype="application/x-www-form-urlencoded">
            <div class="form-group">
              <div class="form-label">
                <label for="carrier">Linia Lotnicza: </label>
              </div>
              <div class="carrier-flex-container">
                <div class="carrier-element">
                  <input type="radio" id="LH" name="carrier" value="LH" checked />
                  <label for="LH">Lufthansa - LH </label>
                </div>
                <div class="carrier-element">
                  <input type="radio" id="OS" name="carrier" value="OS" />
                  <label for="OS">Austrian Airlines - OS</label>
                </div>
                <div class="carrier-element">
                  <input type="radio" id="LX" name="carrier" value="LX" />
                  <label for="LX">Swiss - LX </label>
                </div>
                <div class="carrier-element">
                  <input type="radio" id="SN" name="carrier" value="SN" />
                  <label for="SN">Brussels Airlines - SN </label>
                </div>
                <div class="carrier-element">
                  <input type="radio" id="EN" name="carrier" value="EN" />
                  <label for="EN">Air Dolomiti - EN</label>
                </div>
              </div>
            </div>
            <div class="form-label">
              <label for="carrier">Zakres dat: </label>
            </div>
            <div class="date-flex-container">
              <div class="date-element">
                <label for="date-from"><strong>OD: </strong></label>
                <input type="date" name="date-from" id="date-from" required="required"
                aria-required="true"
                oninvalid="this.setCustomValidity('Proszę wybrać datę początkową')"
                oninput="this.setCustomValidity('')"
                value="">
              </div>
              <div class="date-element">
                <label for="date-to"><strong>DO: </strong></label>
                <input type="date" name="date-to" id="date-to" required>
              </div>
            </div>
            <div class="form-label">
              <label for="date-from">Lub wybierz sezon: </label>
            </div>
            <div class="season-flex-container">
              <div class="season-element">
                <input type="radio" id="W24" name="season" value="W24">
                <label for="W24">W24</label>
              </div>
              <div class="season-element">
                <input type="radio" id="S25" name="season" value="S25">
                <label for="S25">S25</label>
              </div>
              <div class="season-element">
                <input type="radio" id="W25" name="season" value="W25">
                <label for="W25">W25</label>
              </div>
            </div>
            <div class="separation-container">
                <!-- Hidden input for unchecked checkbox -->
              <input type="checkbox" id="separate" name="separate" checked />
              <label for="separate">Odseparuj dni rozkładu</label>
            </div>
            <button type="submit" id="downloadButton" class="download-btn" id="downloadBtn">Pobierz rozkład</button>
          </form>
          <progress id="progressBar" value="0" max="100"></progress>
    <span id="progressText">0%</span>
        </div>
      </body>

    <script>
        const seasonDates = {
            'W24': {
                from: '2024-10-27',
                to: '2025-03-29'
            },
            'S25': {
                from: '2025-03-30',
                to: '2025-10-25'
            },
            'W25': {
                from: '2025-10-26',
                to: '2026-03-28'
            }
        };

        const dateFrom = document.getElementById('date-from');
        const dateTo = document.getElementById('date-to');
        const radioButtons = document.querySelectorAll('input[name="season"]');

        radioButtons.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    const season = seasonDates[e.target.value];
                    dateFrom.value = season.from;
                    dateTo.value = season.to;
                }
            });
        });

        dateFrom.addEventListener('change', () => {
            radioButtons.forEach(radio => radio.checked = false);
        });
        dateTo.addEventListener('change', ()=>{
            radioButtons.forEach(radio => radio.checked = false);
        });

        async function handleDownload(event) {
          event.preventDefault();
      
          // Get date inputs and validate them first
          const dateFrom = document.getElementById('date-from');
          const dateTo = document.getElementById('date-to');
          
          // Reset any previous validation messages
          dateFrom.setCustomValidity('');
          dateTo.setCustomValidity('');
          
          // Check if dates are empty
          if (!dateFrom.value || !dateTo.value) {
              if (!dateFrom.value) {
                  dateFrom.setCustomValidity('Proszę wybrać datę początkową');
                  dateFrom.reportValidity();
              }
              if (!dateTo.value) {
                  dateTo.setCustomValidity('Proszę wybrać datę końcową');
                  dateTo.reportValidity();
              }
              return false;
          }
          
          // Validate date range
          if (dateTo.value < dateFrom.value) {
              dateTo.setCustomValidity('Data końcowa nie może być wcześniejsza niż początkowa');
              dateTo.reportValidity();
              return false;
          }
      
          const loaderContainer = document.querySelector('.loader-container');
          const downloadBtn = document.getElementById('downloadButton');
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');
      
          // Create event source before starting the download
          let eventSource = null;
      
          try {
              // Show loader and disable button
              loaderContainer.style.display = 'flex';
              downloadBtn.disabled = true;
      
              // Setup SSE connection first
              eventSource = new EventSource('/progress');
              eventSource.onmessage = (event) => {
                  const progress = parseInt(event.data);
                  progressBar.value = progress;
                  progressText.textContent = `${progress}%`;
              };
      
              // Gather form data and serialize it
              const form = document.getElementById('downloadForm');
              const formData = new FormData(form);
              const formDataString = new URLSearchParams(formData).toString();
      
              // Make the POST request with the serialized form data
              const response = await fetch('/csv', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: formDataString,
              });
      
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
      
              // Get the filename from the Content-Disposition header
              const contentDisposition = response.headers.get('Content-Disposition');
              let filename = 'data.csv';
              if (contentDisposition) {
                  const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                  if (filenameMatch) {
                      filename = filenameMatch[1];
                  }
              }
      
              // Convert the response to a blob
              const blob = await response.blob();
      
              // Create a download link and trigger it
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();
      
          } catch (error) {
              console.error('Download failed:', error);
              alert('Nie udało się pobrać pliku. Spróbuj ponownie.');
          } finally {
              // Clean up SSE connection
              if (eventSource) {
                  eventSource.close();
              }
      
              // Reset UI
              loaderContainer.style.display = 'none';
              downloadBtn.disabled = false;
              downloadBtn.textContent = 'POBIERZ ROZKŁAD';
              progressBar.value = 0;
              progressText.textContent = '0%';
          }
      
          return false;
      }
      
      // Add event listener
      document.getElementById('downloadButton').addEventListener('click', handleDownload);
    </script>
</body>
</html>